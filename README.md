# k8s-base
Kubernetes base configuration with Traefik, Prometheus &amp; Grafana, cert-manager and Keycloak for Branden Apps

## Secrets
Secrets files in this repository are only for showing an example. When deploying don't use secret files, create them using kubectl commands

### Traefik basic auth
```
$ htpasswd -c -B users admin
$ kubectl create secret generic admin-authsecret --from-file=users
```

Or instead of using the kubectl command you can also make a kubernetes secret:

```yaml
# Note: in a kubernetes secret the string (e.g. generated by htpasswd) must be base64-encoded first.
# To create an encoded user:password pair, the following command can be used:
# $ htpasswd -nb user password | openssl base64
# Or if you already have the file
# $ less file_name | openssl base64

apiVersion: v1
kind: Secret
metadata:
  name: admin-authsecret
  namespace: default

data:
  users: |2
    SECRETCODE
```

## Starting Minikube

```
$ minikube delete && minikube start --memory=8g --cpus=4 --bootstrapper=kubeadm --extra-config=kubelet.authentication-token-webhook=true --extra-config=kubelet.authorization-mode=Webhook --extra-config=scheduler.address=0.0.0.0 --extra-config=controller-manager.address=0.0.0.0
```

## Starting Traefik
First we start the Traefik helm chart

### Update Traefik

```
$ helm repo update
```

### Deploying

```
$ helm install traefik traefik/traefik -f k8s/traefik/helm/values.yml
$ kubectl apply -f k8s/traefik/
```

**Optional:** If you want to test apply the whoami application

```
$ kubectl apply -f k8s/whoami/
```

For `minikube` start the kubernetes `port-forward`

```
$ kubectl port-forward --address 0.0.0.0 service/traefik 80:80 443:443 -n default &
```

If you are on linux and you can't bind port 80 and port 443 after an kubernetes update use the following command

```
$ sudo setcap 'cap_net_bind_service=+ep' /usr/bin/kubectl
```


## Starting Prometheus & Grafana

### Helm install

```
$ helm install prometheus-operator stable/prometheus-operator -f k8s/prometheus/helm/values.yml
```

```
$ kubectl apply -f k8s/prometheus/ingress-routes
```

### Create the resources

```
$ minikube addons disable metrics-server
```

## Starting keycloak TODO
```
$ kubectl create secret generic realm-secret --from-file=k8s/keycloak/realm/realm.json
```

```
$ helm install keycloak codecentric/keycloak -f k8s/keycloak/helm/values.yml
```

```
$ kubectl apply -f k8s/keycloak/ingress-routes
```

## Consul TODO

## Elasticsearch TODO

## Access

```
https://traefik.localhost
https://prometheus.localhost
https://grafana.localhost
https://consul.localhost
https://keycloak.localhost
```

Default grafana login: admin admin

## Updating
